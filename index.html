<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Stock Analyst ($2 - $20)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container {
            max-width: 900px;
        }
        .loading-dot {
            animation: bounce 1s infinite alternate;
        }
        .dot-2 { animation-delay: 0.3s; }
        .dot-3 { animation-delay: 0.6s; }

        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-10px); }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="container mx-auto">

        <!-- Header and Instructions -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-green-700 mb-2">
                Affordable Stock Analyst
            </h1>
            <p class="text-gray-600">
                All searches are strictly limited to stocks priced between <span class="font-bold text-green-600">$2.00</span> and <span class="font-bold text-green-600">$20.00</span>.
            </p>
        </header>

        <!-- Market Status -->
        <div id="marketStatus" class="text-center mb-8 p-4 rounded-xl shadow-md border">
            <!-- Content will be injected by JavaScript -->
        </div>

        <!-- Main Search Card -->
        <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl border border-gray-100 mb-8 space-y-6">
            
            <h2 class="text-2xl font-bold text-gray-800 border-b pb-3">Stock Selection Tools</h2>

            <!-- 1. General Top Stocks Button -->
            <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                <p class="font-semibold text-blue-700 mb-2">Option A: Top 3 General Stock Ideas</p>
                <button id="generalStocksButton" 
                        class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition duration-200 shadow-lg active:shadow-md disabled:bg-blue-300">
                    Choose Top 3 Stocks ($2 - $20)
                </button>
            </div>

            <!-- 2. Thematic Radio Buttons -->
            <div class="p-4 bg-green-50 rounded-lg border border-green-200">
                <p class="font-semibold text-green-700 mb-4">Option B: Choose a Stock Theme (Top 3 Stocks)</p>
                <form id="themeForm" class="grid grid-cols-2 gap-4 text-sm md:text-base">
                    <!-- Radio buttons will be injected here -->
                </form>
                <button type="submit" form="themeForm" id="themeSearchButton"
                        class="w-full mt-4 bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition duration-200 shadow-lg active:shadow-md disabled:bg-green-300">
                    Find Top 3 Stocks for this Theme
                </button>
            </div>

        </div>

        <!-- Output and Loading Area -->
        <div class="space-y-6">
            
            <!-- Loading Indicator -->
            <div id="loading" class="hidden text-center p-8">
                <div class="flex justify-center space-x-2">
                    <div class="loading-dot w-3 h-3 bg-green-500 rounded-full"></div>
                    <div class="loading-dot w-3 h-3 bg-green-500 rounded-full dot-2"></div>
                    <div class="loading-dot w-3 h-3 bg-green-500 rounded-full dot-3"></div>
                </div>
                <p class="mt-4 text-green-600 font-medium">Analyzing market data and generating stock picks... (May take a moment)</p>
            </div>

            <!-- Results Card -->
            <div id="resultsCard" class="bg-white p-6 md:p-8 rounded-xl shadow-xl border border-gray-100 hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">AI Analysis & Stock Ideas</h2>
                <div id="resultsContent" class="prose max-w-none">
                    <!-- Results will be injected here -->
                </div>
                
                <h3 class="text-lg font-semibold text-gray-700 mt-6 mb-2">Sources Consulted:</h3>
                <ul id="sourcesList" class="list-disc list-inside text-sm text-gray-500 space-y-1">
                    <!-- Sources will be injected here -->
                </ul>
            </div>
            
            <!-- Error Message Box -->
            <div id="errorBox" class="hidden bg-red-100 border border-red-400 text-red-700 p-4 rounded-xl shadow-md" role="alert">
                <p class="font-bold">Error:</p>
                <p id="errorMessage"></p>
            </div>
        </div>
    </div>

    <script type="module">
        // Injecting the marked library for Markdown conversion
        (function() {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
            document.head.appendChild(script);
        })();

        // --- Configuration and Constants ---
        const API_BASE_URL = "https://generativelanguage.googleapis.com/v1beta/models/";
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const API_URL = `${API_BASE_URL}${MODEL_NAME}:generateContent`;
        const apiKey = ""; // Canvas will provide this during runtime
        
        const MIN_PRICE = 2.00;
        const MAX_PRICE = 20.00;
        
        const THEME_OPTIONS = [
            "Oversold (RSI below 30)",
            "High Dividend Yield",
            "Strong Insider Buying",
            "Low P/E Ratio (Value)",
            "High Short Interest (Squeeze potential)",
            "Recent Analyst Upgrades",
            "High Growth Potential",
            "High Trading Volume"
        ];

        // --- DOM Elements ---
        const marketStatusDiv = document.getElementById('marketStatus');
        const generalStocksButton = document.getElementById('generalStocksButton');
        const themeForm = document.getElementById('themeForm');
        const themeSearchButton = document.getElementById('themeSearchButton');
        const loadingDiv = document.getElementById('loading');
        const resultsCard = document.getElementById('resultsCard');
        const resultsContent = document.getElementById('resultsContent');
        const sourcesList = document.getElementById('sourcesList');
        const errorBox = document.getElementById('errorBox');
        const errorMessage = document.getElementById('errorMessage');

        // --- Utility Functions ---

        /**
         * Determines and displays the current US stock market status (EST).
         */
        function getMarketStatus() {
            const now = new Date();
            
            // Get current time in New York (EST/EDT)
            const nyTimeStr = now.toLocaleString("en-US", { timeZone: "America/New_York", hour: '2-digit', minute: '2-digit', hour12: true });
            const nyHour = parseInt(nyTimeStr.split(':')[0]);
            const nyMinute = parseInt(nyTimeStr.split(':')[1].split(' ')[0]);
            const nyAMPM = nyTimeStr.split(' ')[2];
            
            const nyDay = now.toLocaleString("en-US", { timeZone: "America/New_York", weekday: 'short' });
            const nyDate = new Date(now.toLocaleString("en-US", { timeZone: "America/New_York" }));
            const dayOfWeek = nyDate.getDay(); // 0 (Sun) to 6 (Sat)
            
            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
            
            let isOpen = false;
            if (!isWeekend) {
                // Convert 12h time to 24h
                let nyHour24 = nyHour;
                if (nyAMPM === 'PM' && nyHour !== 12) {
                    nyHour24 += 12;
                } else if (nyAMPM === 'AM' && nyHour === 12) {
                    nyHour24 = 0;
                }
                
                // Market hours: 9:30 AM (9.5) to 4:00 PM (16.0)
                const totalMinutes = nyHour24 * 60 + nyMinute;
                const marketOpenMinutes = 9 * 60 + 30;
                const marketCloseMinutes = 16 * 60 + 0;

                if (totalMinutes >= marketOpenMinutes && totalMinutes < marketCloseMinutes) {
                    isOpen = true;
                }
            }

            const statusClass = isOpen ? 'bg-green-100 text-green-800 border-green-300' : 'bg-red-100 text-red-800 border-red-300';
            const statusText = isOpen ? 'OPEN' : 'CLOSED';

            marketStatusDiv.className = `text-center mb-8 p-4 rounded-xl shadow-lg font-bold ${statusClass}`;
            marketStatusDiv.innerHTML = `
                <div class="flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    <span>U.S. Stock Market is currently <span class="text-xl">${statusText}</span>.</span>
                </div>
                <p class="text-sm mt-1 font-normal">New York Time: ${nyTimeStr} (${nyDay})</p>
            `;
        }

        /**
         * Hides all dynamic output areas (loading, results, error).
         */
        function resetUI() {
            loadingDiv.classList.add('hidden');
            resultsCard.classList.add('hidden');
            errorBox.classList.add('hidden');
            resultsContent.innerHTML = '';
            sourcesList.innerHTML = '';
            generalStocksButton.disabled = false;
            themeSearchButton.disabled = false;
        }

        /**
         * Exponential backoff retry logic for fetch calls.
         */
        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        if (response.status === 429 && i < maxRetries - 1) {
                            const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        const errorData = await response.json();
                        throw new Error(`API call failed with status ${response.status}: ${errorData.error?.message || 'Unknown error'}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        /**
         * Generates stock content using the Gemini API with search grounding.
         * @param {string} searchTheme - The theme or query to search for.
         */
        async function generateStockContent(searchTheme) {
            const priceConstraint = `**STRICTLY** limited to stocks priced between $${MIN_PRICE.toFixed(2)} and $${MAX_PRICE.toFixed(2)}.`;

            const systemPrompt = `You are a savvy financial analyst specializing in micro and small-cap stocks. The user wants to find the top 3 stock ticker symbols based on the theme/query provided.

            Your analysis MUST adhere to the price constraint: ${priceConstraint}
            
            Based on the user's query and the grounded web search results:
            1. Summarize the general market sentiment or findings related to the theme/query.
            2. List EXACTLY 3 specific stock ticker symbols mentioned in the search results that are relevant to the theme and fall within the ${priceConstraint}. If you cannot find 3, state why (e.g., 'Only two viable stocks were found...').
            3. For each specific stock, provide a brief, one-sentence justification for why it's a top pick for this theme/query (e.g., AI growth, insider buying, low P/E).
            
            Present the final answer in clean Markdown format with bold headings. Do not include any HTML elements or external links in the final list, they will be extracted from citations.`;
            
            const fullQuery = `Find the top 3 stock ticker symbols based on market news, sentiment, and technical indicators for the theme: "${searchTheme}". Remember the price range is ${priceConstraint}.`;


            const payload = {
                contents: [{ parts: [{ text: fullQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            const response = await fetchWithRetry(`${API_URL}?key=${apiKey}`, options);
            const result = await response.json();
            
            const candidate = result.candidates?.[0];
            
            if (!candidate || !candidate.content?.parts?.[0]?.text) {
                console.error("Gemini API Response Error:", result);
                throw new Error("Could not retrieve stock analysis. The API response was empty or malformed.");
            }

            // 1. Extract the generated text
            const text = candidate.content.parts[0].text;

            // 2. Extract grounding sources
            let sources = [];
            const groundingMetadata = candidate.groundingMetadata;
            if (groundingMetadata && groundingMetadata.groundingAttributions) {
                sources = groundingMetadata.groundingAttributions
                    .map(attribution => ({
                        uri: attribution.web?.uri,
                        title: attribution.web?.title,
                    }))
                    .filter(source => source.uri && source.title);
            }

            return { text, sources };
        }
        
        // --- UI Initialization ---

        /**
         * Populates the thematic radio buttons.
         */
        function initializeThemeOptions() {
            themeForm.innerHTML = THEME_OPTIONS.map((theme, index) => `
                <label class="inline-flex items-center p-2 rounded-lg cursor-pointer transition-colors duration-150 hover:bg-gray-100 border border-gray-200">
                    <input type="radio" name="stockTheme" value="${theme}" class="form-radio h-4 w-4 text-green-600 focus:ring-green-500" ${index === 0 ? 'checked' : ''}>
                    <span class="ml-2 text-gray-700">${theme}</span>
                </label>
            `).join('');
        }

        // --- Event Handlers ---
        
        /**
         * Main handler for the API search logic.
         */
        async function handleSearch(query) {
            resetUI();

            generalStocksButton.disabled = true;
            themeSearchButton.disabled = true;
            loadingDiv.classList.remove('hidden');

            try {
                const { text, sources } = await generateStockContent(query);
                
                // Convert Markdown output to HTML for display
                const htmlContent = marked.parse(text);

                resultsContent.innerHTML = htmlContent;
                
                // Add sources
                if (sources.length > 0) {
                    sourcesList.innerHTML = '';
                    sources.forEach(source => {
                        const listItem = document.createElement('li');
                        const link = document.createElement('a');
                        link.href = source.uri;
                        link.textContent = source.title;
                        link.target = "_blank";
                        link.className = "text-blue-500 hover:text-blue-600 hover:underline";
                        listItem.appendChild(link);
                        sourcesList.appendChild(listItem);
                    });
                } else {
                    sourcesList.innerHTML = '<li>No public web sources were used to generate this content.</li>';
                }

                loadingDiv.classList.add('hidden');
                resultsCard.classList.remove('hidden');

            } catch (error) {
                loadingDiv.classList.add('hidden');
                errorMessage.textContent = error.message.includes('API call failed') ? 
                    `The request failed: ${error.message}` : 
                    `An unexpected error occurred: ${error.message}`;
                errorBox.classList.remove('hidden');
                console.error("Full Error:", error);
            } finally {
                generalStocksButton.disabled = false;
                themeSearchButton.disabled = false;
            }
        }
        
        // 1. General Stock Search Button Listener
        generalStocksButton.addEventListener('click', () => {
            const query = "Most discussed and promising stocks based on recent news and sentiment";
            handleSearch(query);
        });

        // 2. Thematic Search Form Listener
        themeForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const selectedRadio = themeForm.querySelector('input[name="stockTheme"]:checked');
            if (selectedRadio) {
                const themeQuery = selectedRadio.value;
                handleSearch(themeQuery);
            } else {
                errorMessage.textContent = "Please select a theme from the radio buttons.";
                errorBox.classList.remove('hidden');
            }
        });

        // Initial setup on load
        window.onload = () => {
            getMarketStatus();
            // Update market status every 60 seconds
            setInterval(getMarketStatus, 60000); 
            initializeThemeOptions();
        };

    </script>
</body>
</html>

